---
import Layout from "../../layouts/Layout.astro";
import { recipes } from "../../data/recipes";

export function getStaticPaths() {
  return recipes.map((r) => ({ params: { slug: r.slug } }));
}

const { slug } = Astro.params;
const recipeIndex = recipes.findIndex((r) => r.slug === slug);
const recipe = recipes[recipeIndex];
if (!recipe) {
  throw new Error(`Unknown recipe slug: ${slug}`);
}

const prev = recipes[(recipeIndex - 1 + recipes.length) % recipes.length];
const next = recipes[(recipeIndex + 1) % recipes.length];
const base = import.meta.env.BASE_URL.endsWith("/") ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;
const withBase = (path: string) => `${base}${path.replace(/^\/+/, "")}`;

function stars(value: number) {
  const full = Math.max(0, Math.min(5, Math.round(value)));
  return "★★★★★☆☆☆☆☆".slice(5 - full, 10 - full);
}
---

<Layout title={`${recipe.title} • JV Kitchen`}>
  <div class="mb-8 flex items-center justify-between gap-4">
    <a
      href={base}
      class="inline-flex items-center gap-2 rounded-full bg-white/70 px-4 py-2 text-sm shadow-soft ring-1 ring-black/5 hover:bg-white"
    >
      <span aria-hidden="true">←</span>
      Back
    </a>

    <div class="flex items-center gap-2">
      <a
        href={withBase(`recipes/${prev.slug}/`)}
        class="rounded-full bg-white/70 px-4 py-2 text-sm shadow-soft ring-1 ring-black/5 hover:bg-white"
        aria-label="Previous recipe"
      >
        Prev
      </a>
      <a
        href={withBase(`recipes/${next.slug}/`)}
        class="rounded-full bg-white/70 px-4 py-2 text-sm shadow-soft ring-1 ring-black/5 hover:bg-white"
        aria-label="Next recipe"
      >
        Next
      </a>
    </div>
  </div>

  <article
    class="relative overflow-hidden rounded-xl2 bg-white/70 p-6 shadow-soft ring-1 ring-black/5 sm:p-10"
    data-prev={withBase(`recipes/${prev.slug}/`)}
    data-next={withBase(`recipes/${next.slug}/`)}
  >
    <div class="pointer-events-none absolute -right-40 -top-40 h-96 w-96 rounded-full bg-cocoa/10 blur-3xl"></div>
    <div class="pointer-events-none absolute -left-44 top-1/2 h-96 w-96 -translate-y-1/2 rounded-full bg-cocoa/5 blur-3xl"></div>

    <header class="grid gap-10 lg:grid-cols-[1fr_320px] lg:items-start">
      <div>
        <h1 class="font-serif text-6xl tracking-tight sm:text-7xl">{recipe.title.toUpperCase()}</h1>

        <section class="mt-6 max-w-md rounded-xl2 bg-sand/60 p-4 ring-1 ring-black/5">
          <div class="font-serif text-3xl text-cocoa">Rating</div>
          <dl class="mt-2 space-y-2 text-sm">
            {recipe.ratings.map((r) => (
              <div class="flex items-center justify-between gap-4">
                <dt class="text-neutral-700">{r.name}:</dt>
                <dd class="font-serif text-xl tracking-wide text-cocoa" aria-label={`${r.value} out of 5`}>
                  {stars(r.value)}
                </dd>
              </div>
            ))}
          </dl>
        </section>
      </div>

      <div class="grid place-items-center">
        <div class="relative w-full overflow-hidden rounded-xl2 bg-paper ring-1 ring-black/5">
          <img src={withBase(recipe.image)} alt="" class="h-64 w-full object-cover sm:h-72" />
        </div>
      </div>
    </header>

    <section class="mt-10">
      <h2 class="font-serif text-5xl tracking-tight text-cocoa">Ingredients</h2>
      <div class="mt-4 rounded-xl2 bg-sand/40 p-6 ring-1 ring-black/5">
        <ul class="columns-1 gap-10 text-sm sm:columns-2">
          {recipe.ingredients.map((item) => (
            <li class="mb-2 break-inside-avoid text-neutral-800">{item}</li>
          ))}
        </ul>
      </div>
    </section>

    <section class="mt-12">
      <h2 class="font-serif text-6xl tracking-tight text-cocoa">Directions</h2>
      <div class="mt-4 rounded-xl2 bg-sand/40 p-6 ring-1 ring-black/5">
        <ol class="list-decimal space-y-2 pl-5 text-sm text-neutral-800">
          {recipe.directions.map((step) => (
            <li>{step}</li>
          ))}
        </ol>
      </div>

      <p class="mt-4 text-xs text-neutral-600">
        Tip: on mobile, swipe left/right anywhere on this card to go to the previous/next recipe.
      </p>
    </section>
  </article>

  <script>
    (() => {
      const el = document.querySelector("article[data-prev][data-next]");
      if (!el) return;
      const prev = el.getAttribute("data-prev");
      const next = el.getAttribute("data-next");
      if (!prev || !next) return;

      let startX = 0;
      let startY = 0;
      let tracking = false;

      el.addEventListener(
        "touchstart",
        (e) => {
          const t = e.touches?.[0];
          if (!t) return;
          startX = t.clientX;
          startY = t.clientY;
          tracking = true;
        },
        { passive: true }
      );

      el.addEventListener(
        "touchend",
        (e) => {
          if (!tracking) return;
          tracking = false;
          const t = e.changedTouches?.[0];
          if (!t) return;
          const dx = t.clientX - startX;
          const dy = t.clientY - startY;

          // ignore mostly-vertical swipes (scrolling)
          if (Math.abs(dy) > Math.abs(dx)) return;

          const threshold = 60;
          if (dx > threshold) window.location.assign(prev);
          if (dx < -threshold) window.location.assign(next);
        },
        { passive: true }
      );
    })();
  </script>
</Layout>

